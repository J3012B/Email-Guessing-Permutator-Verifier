<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Verifier</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface-hover: #222632;
      --border: #2a2e3b;
      --text: #e4e4e7;
      --text-muted: #8b8d97;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --green: #22c55e;
      --green-bg: rgba(34, 197, 94, 0.1);
      --red: #ef4444;
      --red-bg: rgba(239, 68, 68, 0.1);
      --yellow: #eab308;
      --yellow-bg: rgba(234, 179, 8, 0.1);
      --radius: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      padding: 48px 20px 80px;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    header p {
      color: var(--text-muted);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 11px 14px;
      font-size: 0.95rem;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }

    input::placeholder { color: #4a4d58; }
    input:focus { border-color: var(--accent); }

    .btn {
      grid-column: 1 / -1;
      margin-top: 4px;
      padding: 13px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover { background: var(--accent-hover); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .status-bar {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 24px;
      padding: 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .status-bar.visible { display: flex; }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-text { font-variant-numeric: tabular-nums; }

    .results {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .results-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .results-header h2 {
      font-size: 1rem;
      font-weight: 600;
    }

    .results-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .result-row {
      position: relative;
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      transition: background 0.15s;
      cursor: help;
    }

    .result-row:hover { background: var(--surface-hover); }

    .result-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      min-width: 320px;
      max-width: 480px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
      font-size: 0.8rem;
      line-height: 1.5;
    }

    .result-row:hover .result-tooltip {
      opacity: 1;
    }

    .result-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--border);
    }

    .tooltip-title {
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 0.75rem;
    }

    .tooltip-key {
      color: var(--text-muted);
      margin-right: 12px;
    }

    .tooltip-value {
      color: var(--text);
      text-align: right;
      word-break: break-word;
    }

    .tooltip-value.true { color: var(--green); }
    .tooltip-value.false { color: var(--red); }
    .tooltip-value.null { color: var(--text-muted); font-style: italic; }
    .tooltip-value.error { color: var(--red); }

    .result-email {
      font-family: "SF Mono", "Fira Code", "Cascadia Code", monospace;
      font-size: 0.9rem;
      word-break: break-all;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      white-space: nowrap;
    }

    .badge.deliverable { background: var(--green-bg); color: var(--green); }
    .badge.risky { background: var(--yellow-bg); color: var(--yellow); }
    .badge.undeliverable { background: var(--red-bg); color: var(--red); }
    .badge.error { background: var(--red-bg); color: var(--red); }
    .badge.tier { background: rgba(99, 102, 241, 0.15); color: var(--accent); }
    .badge.pending { background: rgba(139, 141, 151, 0.15); color: var(--text-muted); }

    .score {
      font-size: 0.85rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      min-width: 48px;
      text-align: right;
    }

    .score.high { color: var(--green); }
    .score.medium { color: var(--yellow); }
    .score.low { color: var(--red); }

    .error-msg {
      text-align: center;
      padding: 16px;
      color: var(--red);
      background: var(--red-bg);
      border-radius: var(--radius);
      margin-top: 24px;
      font-size: 0.9rem;
    }

    @media (max-width: 500px) {
      .form-grid { grid-template-columns: 1fr; }
      .form-group.full { grid-column: 1; }
      .btn { grid-column: 1; }
      .result-row { grid-template-columns: 1fr auto; }
      .badge.tier { display: none; }
      .score { display: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Outreach Email Verifier</h1>
      <p>Enter a name and company domain to discover and verify probable email addresses.</p>
    </header>

    <form class="card" id="form">
      <div class="form-grid">
        <div class="form-group">
          <label for="firstName">First Name</label>
          <input type="text" id="firstName" placeholder="Jane" required />
        </div>
        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input type="text" id="lastName" placeholder="Smith" required />
        </div>
        <div class="form-group full">
          <label for="domain">Domain</label>
          <input type="text" id="domain" placeholder="acme.com" required />
        </div>
        <button class="btn" type="submit" id="submitBtn">Verify Email Variations</button>
      </div>
    </form>

    <div class="status-bar" id="statusBar">
      <div class="spinner"></div>
      <span class="progress-text" id="statusText">Verifying...</span>
    </div>

    <div id="errorContainer"></div>
    <div id="resultsContainer"></div>
  </div>

  <script>
    const form = document.getElementById("form");
    const submitBtn = document.getElementById("submitBtn");
    const statusBar = document.getElementById("statusBar");
    const statusText = document.getElementById("statusText");
    const errorContainer = document.getElementById("errorContainer");
    const resultsContainer = document.getElementById("resultsContainer");

    let currentEventSource = null;
    let results = {};
    let totalApiCalls = 0;
    let deliverableCount = 0;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Close any existing connection
      if (currentEventSource) {
        currentEventSource.close();
      }

      errorContainer.innerHTML = "";
      resultsContainer.innerHTML = "";
      results = {};
      totalApiCalls = 0;
      deliverableCount = 0;

      const firstName = document.getElementById("firstName").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      let domain = document.getElementById("domain").value.trim().toLowerCase();

      domain = domain.replace(/^https?:\/\//, "").replace(/^www\./, "").replace(/\/.*$/, "");

      if (!firstName || !lastName || !domain) return;

      submitBtn.disabled = true;
      submitBtn.textContent = "Verifying...";
      statusBar.classList.add("visible");
      statusText.textContent = "Initializing...";

      const url = `/api/verify-stream?firstName=${encodeURIComponent(firstName)}&lastName=${encodeURIComponent(lastName)}&domain=${encodeURIComponent(domain)}`;
      currentEventSource = new EventSource(url);

      currentEventSource.addEventListener("init", (e) => {
        const data = JSON.parse(e.data);
        statusText.textContent = `Checking ${data.variations.length} variations...`;
        initializeResults(data.variations);
      });

      currentEventSource.addEventListener("tier-start", (e) => {
        const data = JSON.parse(e.data);
        statusText.textContent = `Tier ${data.tier}: ${data.name} (${data.count} variations)`;
      });

      currentEventSource.addEventListener("result", (e) => {
        const data = JSON.parse(e.data);
        updateResult(data);
      });

      currentEventSource.addEventListener("tier-complete", (e) => {
        const data = JSON.parse(e.data);
        if (data.deliverable > 0) {
          statusText.textContent = `✓ Tier ${data.tier} complete - Found ${data.deliverable} deliverable!`;
        } else {
          statusText.textContent = `Tier ${data.tier} complete - No deliverable found`;
        }
      });

      currentEventSource.addEventListener("complete", (e) => {
        const data = JSON.parse(e.data);
        totalApiCalls = data.apiCallsUsed;
        
        let message = `✓ Complete - ${deliverableCount} deliverable`;
        if (data.apiCallsSaved > 0) {
          message += ` · Saved ${data.apiCallsSaved} API calls!`;
        }
        statusText.textContent = message;
        
        setTimeout(() => {
          statusBar.classList.remove("visible");
        }, 3000);

        updateHeader();
        currentEventSource.close();
        submitBtn.disabled = false;
        submitBtn.textContent = "Verify Email Variations";
      });

      currentEventSource.addEventListener("error", (e) => {
        try {
          const data = JSON.parse(e.data);
          statusBar.classList.remove("visible");
          errorContainer.innerHTML = `<div class="error-msg">${escapeHtml(data.message)}</div>`;
          currentEventSource.close();
          submitBtn.disabled = false;
          submitBtn.textContent = "Verify Email Variations";
        } catch (err) {
          console.error("Error parsing error event:", err);
        }
      });

      currentEventSource.onerror = (e) => {
        if (currentEventSource.readyState === EventSource.CLOSED) {
          // Stream ended normally
          return;
        }
        
        // Give a moment for the custom "error" event to fire first
        setTimeout(() => {
          if (errorContainer.innerHTML === "") {
            statusBar.classList.remove("visible");
            errorContainer.innerHTML = `<div class="error-msg">Connection error - check console for details</div>`;
            console.error("EventSource connection error:", e);
          }
        }, 100);
        
        currentEventSource.close();
        submitBtn.disabled = false;
        submitBtn.textContent = "Verify Email Variations";
      };
    });

    function initializeResults(variations) {
      const header = `
        <div class="results-header">
          <h2>Results</h2>
          <span id="resultsStats">0 deliverable · 0 checked</span>
        </div>`;

      const rows = variations.map((v) => {
        results[v.email] = { ...v, status: "pending" };
        return createResultRow(v.email, v.tier, { status: "pending" });
      }).join("");

      resultsContainer.innerHTML = `<div class="results">${header}${rows}</div>`;
    }

    function updateResult(data) {
      results[data.email] = data;
      
      if (data.is_deliverable) {
        deliverableCount++;
      }

      const row = document.querySelector(`[data-email="${escapeHtml(data.email)}"]`);
      if (row) {
        row.outerHTML = createResultRow(data.email, data.tier, data);
      }

      updateHeader();
    }

    function updateHeader() {
      const stats = document.getElementById("resultsStats");
      if (stats) {
        const checked = Object.values(results).filter(r => r.status !== "pending").length;
        const apiInfo = totalApiCalls > 0 ? ` · ${totalApiCalls} API calls` : '';
        stats.textContent = `${deliverableCount} deliverable · ${checked} checked${apiInfo}`;
      }
    }

    function createTooltip(data) {
      if (data.status === "pending") {
        return `<div class="result-tooltip">
          <div class="tooltip-title">Pending Verification</div>
          <div class="tooltip-row">
            <span class="tooltip-key">Status:</span>
            <span class="tooltip-value">Waiting for API response...</span>
          </div>
        </div>`;
      }

      if (data.error) {
        return `<div class="result-tooltip">
          <div class="tooltip-title">Error Details</div>
          <div class="tooltip-row">
            <span class="tooltip-key">Error:</span>
            <span class="tooltip-value error">${escapeHtml(data.error)}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-key">Email:</span>
            <span class="tooltip-value">${escapeHtml(data.email)}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-key">Tier:</span>
            <span class="tooltip-value">${data.tier}</span>
          </div>
        </div>`;
      }

      // Success response - show all API fields
      const fields = [
        { key: 'email', label: 'Email' },
        { key: 'is_deliverable', label: 'Deliverable' },
        { key: 'score', label: 'Score', format: (v) => v != null ? (v * 100).toFixed(1) + '%' : 'N/A' },
        { key: 'syntax_valid', label: 'Valid Syntax' },
        { key: 'can_connect_smtp', label: 'SMTP Connection' },
        { key: 'mx_records', label: 'MX Records' },
        { key: 'is_catch_all', label: 'Catch-all' },
        { key: 'is_disposable', label: 'Disposable' },
        { key: 'is_role_account', label: 'Role Account' },
        { key: 'is_disabled', label: 'Disabled' },
        { key: 'is_inbox_full', label: 'Inbox Full' },
        { key: 'free', label: 'Free Provider' },
        { key: 'domain', label: 'Domain' },
        { key: 'user', label: 'User' },
        { key: 'did_you_mean', label: 'Did You Mean' }
      ];

      const rows = fields.map(field => {
        const value = data[field.key];
        const displayValue = field.format ? field.format(value) : value;
        
        let valueClass = '';
        if (typeof displayValue === 'boolean') {
          valueClass = displayValue ? 'true' : 'false';
        } else if (displayValue === null || displayValue === '') {
          valueClass = 'null';
        }

        const displayText = displayValue === null || displayValue === '' 
          ? 'null' 
          : displayValue === true 
            ? 'true' 
            : displayValue === false 
              ? 'false' 
              : escapeHtml(String(displayValue));

        return `<div class="tooltip-row">
          <span class="tooltip-key">${field.label}:</span>
          <span class="tooltip-value ${valueClass}">${displayText}</span>
        </div>`;
      }).join('');

      return `<div class="result-tooltip">
        <div class="tooltip-title">API Response Details</div>
        ${rows}
      </div>`;
    }

    function createResultRow(email, tier, data) {
      const tierBadge = `<span class="badge tier">Tier ${tier}</span>`;
      const emailAttr = `data-email="${escapeHtml(email)}"`;
      const tooltip = createTooltip(data);

      if (data.status === "pending") {
        return `
          <div class="result-row" ${emailAttr}>
            ${tooltip}
            <span class="result-email">${escapeHtml(email)}</span>
            ${tierBadge}
            <span class="badge pending">Verifying</span>
            <span class="score">
              <div class="spinner" style="width: 14px; height: 14px;"></div>
            </span>
          </div>`;
      }

      if (data.error) {
        return `
          <div class="result-row" ${emailAttr}>
            ${tooltip}
            <span class="result-email">${escapeHtml(email)}</span>
            ${tierBadge}
            <span class="badge error">Error</span>
            <span class="score low">--</span>
          </div>`;
      }

      const score = data.score != null ? data.score : 0;
      const scoreClass = score >= 0.7 ? "high" : score >= 0.4 ? "medium" : "low";
      const badgeClass = data.is_deliverable ? "deliverable" : score >= 0.4 ? "risky" : "undeliverable";
      const badgeLabel = data.is_deliverable ? "Deliverable" : score >= 0.4 ? "Risky" : "Undeliverable";

      return `
        <div class="result-row" ${emailAttr}>
          ${tooltip}
          <span class="result-email">${escapeHtml(email)}</span>
          ${tierBadge}
          <span class="badge ${badgeClass}">${badgeLabel}</span>
          <span class="score ${scoreClass}">${(score * 100).toFixed(0)}%</span>
        </div>`;
    }

    function escapeHtml(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
